<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Marine Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #0f172a; font-family: 'Segoe UI', sans-serif; }
        #map { width: 100%; height: 100vh; }
        
        /* Smaller, cleaner permanent labels */
        .leaflet-tooltip-pane .city-label {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #38bdf8;
            border-radius: 8px;
            color: white;
            padding: 8px;
            font-size: 11px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            min-width: 130px;
        }
        
        .city-name { font-weight: bold; color: #38bdf8; border-bottom: 1px solid #334155; padding-bottom: 4px; margin-bottom: 4px; display: block; text-transform: uppercase; font-size: 10px; }
        .time-row { font-size: 14px; font-weight: bold; margin: 4px 0; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 5px; }
        .temp-val { font-weight: bold; }
        .high { color: #f87171; }
        .low { color: #60a5fa; }
        .tide-row { margin-top: 5px; color: #fbbf24; font-size: 10px; font-weight: 600; }
        
        /* Remove default Leaflet tooltip arrow */
        .leaflet-tooltip-left:before, .leaflet-tooltip-right:before { display: none; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', {
            center: [15, 10],
            zoom: 2,
            zoomControl: false // Cleaner look
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        const cities = [
            { name: "Shanghai", lat: 31.23, lon: 121.47, tz: "Asia/Shanghai", tideOffset: 0 },
            { name: "London", lat: 51.50, lon: -0.12, tz: "Europe/London", tideOffset: 1.5 },
            { name: "New York", lat: 40.71, lon: -74.00, tz: "America/New_York", tideOffset: -4 },
            { name: "Sydney", lat: -33.86, lon: 151.20, tz: "Australia/Sydney", tideOffset: 10 }
        ];

        async function updateDashboard() {
            // Remove old layers to refresh data
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });

            for (const city of cities) {
                try {
                    // 1. Fetch Weather
                    const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&daily=temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=2`);
                    const wData = await wRes.json();
                    const max = wData.daily.temperature_2m_max[1];
                    const min = wData.daily.temperature_2m_min[1];

                    // 2. Calculate local time
                    const now = new Date();
                    const timeStr = new Intl.DateTimeFormat('en-US', {
                        hour: '2-digit', minute: '2-digit', hour12: true, timeZone: city.tz
                    }).format(now);

                    // 3. Est. High Tide (Simplified for Dashboard)
                    // High tides cycle approx every 12h 25m.
                    const highTide = "12:45 PM"; // Replace with dynamic API call if using WorldTides later

                    const content = `
                        <div class="city-label">
                            <span class="city-name">${city.name}</span>
                            <div class="time-row">${timeStr}</div>
                            <div class="data-grid">
                                <div><span class="tide-label">Max</span><br><span class="temp-val high">${max}Â°C</span></div>
                                <div><span class="tide-label">Min</span><br><span class="temp-val low">${min}Â°C</span></div>
                            </div>
                            <div class="tide-row">ðŸŒŠ High Tide: ${highTide}</div>
                        </div>
                    `;

                    L.marker([city.lat, city.lon], { opacity: 0 }) // Hidden marker
                        .addTo(map)
                        .bindTooltip(content, { 
                            permanent: true, 
                            direction: 'center', 
                            className: 'custom-tooltip' 
                        }).openTooltip();

                } catch (e) {
                    console.log("Error for " + city.name);
                }
            }
        }

        updateDashboard();
        setInterval(updateDashboard, 60000); // Refresh every minute
    </script>
</body>
</html>
