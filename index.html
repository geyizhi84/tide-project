<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Map: Time & Forecast</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #0f172a; font-family: sans-serif; }
        #map { width: 100%; height: 100vh; }
        
        /* Custom styling for the popups */
        .city-popup { text-align: center; color: #1e293b; }
        .city-popup h2 { margin: 0 0 5px 0; color: #0369a1; font-size: 1.2rem; }
        .city-popup .time-box { font-size: 1.5rem; font-weight: bold; margin: 10px 0; color: #334155; }
        .city-popup .temp-box { background: #f1f5f9; padding: 8px; border-radius: 8px; font-size: 0.9rem; }
        .temp-high { color: #e11d48; font-weight: bold; }
        .temp-low { color: #2563eb; font-weight: bold; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // 1. Initialize the Map centered on the world
        const map = L.map('map').setView([20, 0], 2);

        // 2. Add a Dark-themed World Map (CartoDB Dark Matter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CartoDB'
        }).addTo(map);

        // 3. City Data Configuration
        const cities = [
            { name: "Shanghai", lat: 31.23, lon: 121.47, tz: "Asia/Shanghai" },
            { name: "London", lat: 51.50, lon: -0.12, tz: "Europe/London" },
            { name: "New York", lat: 40.71, lon: -74.00, tz: "America/New_York" },
            { name: "Sydney", lat: -33.86, lon: 151.20, tz: "Australia/Sydney" }
        ];

        // 4. Update Clocks and Weather
        async function updateCityData() {
            for (const city of cities) {
                try {
                    // Fetch Tomorrow's Forecast (daily max/min)
                    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&daily=temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=2`;
                    const response = await fetch(weatherUrl);
                    const data = await response.json();
                    
                    // index 1 is tomorrow
                    const maxTemp = data.daily.temperature_2m_max[1];
                    const minTemp = data.daily.temperature_2m_min[1];

                    // Get Local Time
                    const localTime = new Intl.DateTimeFormat('en-US', {
                        hour: '2-digit', minute: '2-digit', hour12: true, timeZone: city.tz
                    }).format(new Date());

                    // 5. Create Marker and Popup
                    const popupContent = `
                        <div class="city-popup">
                            <h2>${city.name}</h2>
                            <div class="time-box">${localTime}</div>
                            <div class="temp-box">
                                Tomorrow: <span class="temp-high">${maxTemp}°C</span> / 
                                <span class="temp-low">${minTemp}°C</span>
                            </div>
                        </div>
                    `;

                    L.marker([city.lat, city.lon])
                        .addTo(map)
                        .bindPopup(popupContent, { minWidth: 180 });

                } catch (e) {
                    console.error("Error fetching data for " + city.name, e);
                }
            }
        }

        updateCityData();
    </script>
</body>
</html>
